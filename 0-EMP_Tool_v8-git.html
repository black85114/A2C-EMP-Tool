<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECAD模型備份替換工具 v0.8</title>
    <script src="./creojs.js"></script>
	<link rel="stylesheet" type="text/css" href="./style.css">
	<script type="text/creojs">
		// === 原有的 Creo.JS 函數 (保持不變) ===
		function getSession() {
			return pfcGetCurrentSession();
		}
		
		function getCurrentModelName() {
			try {
				const session = getSession();
				const model = session.CurrentModel;
				if (model) {
					let fileName = model.FileName;
					if (fileName.includes(".")) {
						fileName = fileName.substring(0, fileName.lastIndexOf("."));
					}
					return fileName;
				} else {
					return null;
				}
			} catch (error) {
				return null;
			}
		}
		
		function getCurrentDirectory() {
			try {
				const session = getSession();
				return session.GetCurrentDirectory();
			} catch (error) {
				return null;
			}
		}
		
		function findBackupDirectory() {
			try {
				const session = getSession();
				const model = session.CurrentModel;
				const currentDir = model.Origin;
				const lastSlashIndex = Math.max(currentDir.lastIndexOf("\\"), currentDir.lastIndexOf("/"));
				const modelPath = currentDir.substring(0, lastSlashIndex);    
				return modelPath;
			} catch (error) {
				return null;
			}
		}
		
		function setWorkingDirectory(fullPath) {
			try {
				const session = getSession();
				session.ChangeDirectory(fullPath);
				return session.GetCurrentDirectory();
			} catch (error) {
				return { error: error.message };
			}
		}
		
		function runColorMacro() {
			try {
				const session = getSession();
				const macro_paint = "~ Select `main_dlg_cur` `PHTLeft.AssyTree` 1 `T2 7`;" +
									"~ Command `ProCmdMakeActive@PopupMenuTree`;" +
									"~ Command `ProCmdMdlTreeSearch`;" +                              
									"~ Open `selspecdlg0` `SelOptionRadio`" +
									"~ Close `selspecdlg0` `SelOptionRadio`;" +
									"~ Select `selspecdlg0` `SelOptionRadio` 1 `Geometric Body`;" +
									"~ Open `selspecdlg0` `ExtRulesLayout.ExtBasicNameLayout.BasNameComp`;" +
									"~ Close `selspecdlg0` `ExtRulesLayout.ExtBasicNameLayout.BasNameComp`;" +
									"~ Select `selspecdlg0` `ExtRulesLayout.ExtBasicNameLayout.BasNameComp` 1 ` != `;" +
									"~ Update `selspecdlg0` `ExtRulesLayout.ExtBasicNameLayout.BasicNameList` `*`;" +
									"~ Activate `selspecdlg0` `EvaluateBtn`;" +
									"~ Activate `selspecdlg0` `ApplyBtn`;" +            
									"~ Activate `selspecdlg0` `CancelButton`;" +
									"~ Activate `main_dlg_cur` `page_View_control_btn` 1;" +
									"~ Select `main_dlg_cur` `View:ProCmdViewGallery`;" +
									"~ Select `main_dlg_cur` `ProCmdViewGallery_layoutph.palette_holder.myAppPalette.NamesList` 1 `ptc-metallic-blue`;" +
									"~ Timer `` `` `Gallery_UI_Timer`;" +
									"~ Close `main_dlg_cur` `View:ProCmdViewGallery`;" +
									"~ Select `main_dlg_cur` `PHTLeft.AssyTree` 1 `node0`;" +
									"~ Command `ProCmdMakeActive@PopupMenuTree` ;" +
									"~ Close `main_dlg_cur` `Model:ProCmdViewGallery`;"+
									"~ LButtonArm `main_dlg_cur` `proe_win` 9 765 717 0 1 1461 815 1920 1080 1709707;" +
									"~ LButtonDisarm `main_dlg_cur` `proe_win` 9 765 717 0 0 1461 815 1920 1080 1709794;";
				
				session.RunMacro(macro_paint);
				return true;
			} catch (error) {
				return { error: error.message };
			}
		}
		
		function checkColoringStatus() {
			try {
				const session = getSession();
				const model = session.CurrentModel;
				
				if (model) {
					return model.IsActive();
				}
				return false;
			} catch (error) {
				return false;
			}
		}
		
		function runDelMacro() {
			try {
				const session = getSession();
				const macro_del = 	"~ Command `ProCmdMdlTreeSearch` ;"+
									"~ Open `selspecdlg0` `SelOptionRadio`;"+
									"~ Close `selspecdlg0` `SelOptionRadio`;"+
									"~ Select `selspecdlg0` `SelOptionRadio` 1 `Part`;"+
									"~ Select `selspecdlg0` `CascadeButton1`;"+
									"~ Close `selspecdlg0` `CascadeButton1`;"+
									"~ Activate `selspecdlg0` `CondBuilderCheck` 1;"+
									"~ Update `selspecdlg0` `ExtRulesLayout.ExtBasicNameLayout.BasicNameList` `H*`;"+
									"~ Activate `selspecdlg0` `AddRuleBtn`;"+
									"~ Update `selspecdlg0` `ExtRulesLayout.ExtBasicNameLayout.BasicNameList` `TEST*`;"+
									"~ Activate `selspecdlg0` `AddRuleBtn`;"+
									"~ Update `selspecdlg0` `ExtRulesLayout.ExtBasicNameLayout.BasicNameList` `SH*`;"+
									"~ Activate `selspecdlg0` `AddRuleBtn`;"+
									"~ Update `selspecdlg0` `ExtRulesLayout.ExtBasicNameLayout.BasicNameList` `K*`;"+
									"~ Activate `selspecdlg0` `AddRuleBtn`;"+
									"~ Activate `selspecdlg0` `EvaluateBtn`;"+
									"~ Select `selspecdlg0` `ResultList` -1;;"+
									"~ Activate `selspecdlg0` `ApplyBtn`;"+
									"~ Activate `selspecdlg0` `CancelButton`;"+
									"~ Command `ProCmdEditDelete` ;"+
									"~ Activate `del_sup_msg` `ok`;";
				session.RunMacro(macro_del);
				return true;
			} catch (error) {
				return { error: error.message };
			}
		}	
		
		function runBackupMacro(folderName) {
			try {
				const session = getSession();
				const macro_backup = "~ Command `ProCmdModelBackup` ;" +
									 "~ RButtonArm `file_saveas` `ph_list.Filelist` ``;" +                                     
									 "~ PopupOver `file_saveas` `listPopup` 1 `ph_list.Filelist`;" +                           
									 "~ Open `file_saveas` `listPopup`;" +
									 "~ Close `file_saveas` `listPopup`;" +
									 "~ Activate `file_saveas` `newdirectory_pb0`;" +
									 "~ Update `getnewdir` `new_dir_input` `" + folderName + "`;" +
									 "~ Activate `getnewdir` `OK_button`;" +
									 "~ Activate `file_saveas` `OK`;"+
									 "~ Close `unembedded_browser_dialog` `unembedded_browser_dialog`";
				
				session.RunMacro(macro_backup);
				return folderName;
			} catch (error) {
				return { error: error.message };
			}
		}
		
		function checkBackupStatus(folderName) {
			try {
				const session = getSession();
				const files = session.ListFiles("*", true);
				
				for (let i = 0; i < files.Count; i++) {
					const fileEntry = files.Item(i);
					if (fileEntry.toUpperCase().endsWith(folderName.toUpperCase())) {
						 return true;
					}
				}
				return false;
			} catch (error) {
				return false;
			}
		}
		
		function runCleanMacro() {
			try {
				const session = getSession();
				const macro_clean = 
									"~ Command `ProCmdWinCloseGroup` ;" +
									"~ Command `ProCmdModelEraseNotDisp` ;" +    
									"~ Activate `file_erase_nd` `ok_pb`;"+
									"~ Command `ProCmdBrowserBtn`  1;";
				
				session.RunMacro(macro_clean);
				return true;
			} catch (error) {
				return { error: error.message };
			}
		}
		
		function runBatchMacro() {
			try {
				const session = getSession();
				const macro_bat =  "@SYSTEM xcopy \"\\\\\\\\10.1.182.31\\\\a2\\\\A2C\\\\Temp\\\\WEB\\\\000-EMP_Translator_v8.ps1\" \"\%cd\%\" /Y  \\n "+
									"start cmd /c powershell.exe -ExecutionPolicy Bypass -File  \".\\\\000-EMP_Translator_v8.ps1\"\\n exit;" ;
				
				session.RunMacro(macro_bat);
				return true;
			} catch (error) {
				return { error: error.message };
			}
		}
		
		function checkCleanStatus() {
			try {
				const session = getSession();
				const models = session.ListModels();
				return models.Count <= 1;
			} catch (error) {
				return false;
			}
		}
		
		function runOpenAsmMacro(folderName) {
			try {
				const session = getSession();
				const asmFileName = `0-${folderName}.asm`;
				
				const macro_open_asm = 	"~ Activate `main_dlg_cur` `EMBED_BROWSER Close` ;"+
										"~ Command `ProCmdModelOpen` ;"+
										"~ Select `file_open` `Ph_list.Filelist` 1 `'${asmFileName}'` ;"+
										"~ Activate `file_open` `Ph_list.Filelist` 1 `'${asmFileName}'` ;"+
										"~ Activate `open_rep` `OpenCascBtn`;";                                                     
										
				session.RunMacro(macro_open_asm);
				return true;
			} catch (error) {
				return { error: error.message };
			}
		}
		
		// === 新增的配置管理函數 ===
		function updateConfigFile(configData) {
			try {
				const session = getSession();
				
				// 構建完整的配置內容
				const configLines = [
					"FtpLibEnabled=" + configData.ftpLibEnabled,
					"LocalLibEnabled=" + configData.localLibEnabled,
					"CopyMatchingSourceFolders=" + configData.copyMatchingSourceFolders,
					"AutoZeroRenameEnabled=" + configData.autoZeroRenameEnabled,
					"SelfDestructEnabled=" + configData.selfDestructEnabled,
					"NasHostName=" + configData.nasHostName,
					"StatusIP=" + configData.statusIP,
					"LocalLibAddr=" + configData.localLibAddr
				];
				
				// 構建 Batch 指令
				let batchCommand = "@SYSTEM cmd /c ";
				
				// 刪除舊檔案
				batchCommand += "del D:\\\\\\EMP-Config.ini\\n";
				
				// 逐行寫入檔案
				for (let i = 0; i < configLines.length; i++) {
					const line = configLines[i];
					if (i === 0) {
						batchCommand += "echo "+ line + " >> D:\\\\\\EMP-Config.ini\\n";
					} else {
						batchCommand += "echo " + line + " >> D:\\\\\\EMP-Config.ini\\n";
					}
				}
								
				session.RunMacro(batchCommand);
				return true;
			} catch (error) {
				return { error: error.message };
			}
		}
		
		// 新增：執行開啟 ASM 巨集
		function runOpenAsmMacro(folderName) {
			try {
				const session = getSession();
				const asmFileName = `0-${folderName}.asm`; // Construct the filename like '0-MODELNAME.asm'
				
				// Note the single quotes around the filename in the macro, as per your example
				const macro_open_asm = 	"~ Activate `main_dlg_cur` `EMBED_BROWSER Close` ;"+
										"~ Command `ProCmdModelOpen` ;"+
										"~ Select `file_open` `Ph_list.Filelist` 1 `'${asmFileName}'` ;"+
										"~ Activate `file_open` `Ph_list.Filelist` 1 `'${asmFileName}'` ;"+
										"~ Activate `open_rep` `OpenCascBtn`;";                                                     
										
				session.RunMacro(macro_open_asm);
				return true; // Indicate success
			} catch (error) {
				return { error: error.message };
			}
		}	
		
		 // === 一鍵部署函數 (保持原有 macro 代碼) ===
		function deployMapkey() {
			try {
				const session = getSession();
				const macro_mapkey = "~ Command `ProCmdUtilMacros`;"+ 
									"~ Select `mapkey_main` `ImpExpCascButton`;"+
									"~ Close `mapkey_main` `ImpExpCascButton`;"+
									"~ Activate `mapkey_main` `psh_import`;"+
									"~ Input `file_open` `opt_EMBED_BROWSER_TB_SAB_LAYOUT` `\\\\\\\\10.1.182.31\\\\a2\\\\A2C\\\\Temp\\\\WEB`;"+
									"~ Update `file_open` `opt_EMBED_BROWSER_TB_SAB_LAYOUT` `\\\\\\\\10.1.182.31\\\\a2\\\\A2C\\\\Temp\\\\WEB`;"+
									"~ Activate `file_open` `opt_EMBED_BROWSER_TB_SAB_LAYOUT`;"+
									"~ FocusIn `file_open` `EMBED_BROWSER_SEARCH_IP`;"+
									"~ FocusOut `file_open` `EMBED_BROWSER_SEARCH_IP`;"+
									"~ Select `file_open` `Ph_list.Filelist` 1 `mapkeys.pro`;"+
									"~ Activate `file_open` `Ph_list.Filelist` 1 `mapkeys.pro`;"+
									"~ Select `mapkey_main` `SaveCascBtn`;"+
									"~ Close `mapkey_main` `SaveCascBtn`;"+
									"~ Activate `mapkey_main` `psh_save_changed`;"+
									"~ Activate `mapkey_main` `CloseButton`;"; 
				
				session.RunMacro(macro_mapkey);
				return true;
			} catch (error) {
				return { error: error.message };
			}
		}
		
		function deployRibbon() {
			try {
				const session = getSession();
				const macro_ribbon = "~ Command `AdbCmdOptCustDlg` ;"+
									"~ Open `ribbon_options_dialog` `RibbonCustMenuLayout.RibbonTreeLay.CustRbnModeOptionMenu`;"+
									"~ Close `ribbon_options_dialog` `RibbonCustMenuLayout.RibbonTreeLay.CustRbnModeOptionMenu`;"+
									"~ Select `ribbon_options_dialog` `RibbonCustMenuLayout.RibbonTreeLay.CustRbnModeOptionMenu` 1 `CustRbnPopularModes`;"+
									"~ FocusIn `ribbon_options_dialog` `RibbonCustMenuLayout.RibbonTreeLay.RibbonTree`;"+
									"~ FocusOut `ribbon_options_dialog` `RibbonCustMenuLayout.RibbonTreeLay.RibbonTree`;"+
									"~ Activate `ribbon_options_dialog` `RibbonCustMenuLayout.ImportPB`;"+
									"~ Input `file_open` `opt_EMBED_BROWSER_TB_SAB_LAYOUT` `\\\\\\\\10.1.182.31\\\\a2\\\\A2C\\\\Temp\\\\WEB`;"+
									"~ Update `file_open` `opt_EMBED_BROWSER_TB_SAB_LAYOUT` `\\\\\\\\10.1.182.31\\\\a2\\\\A2C\\\\Temp\\\\WEB`;"+
									"~ Activate `file_open` `opt_EMBED_BROWSER_TB_SAB_LAYOUT`;"+
									"~ FocusIn `file_open` `EMBED_BROWSER_SEARCH_IP`;"+
									"~ FocusOut `file_open` `EMBED_BROWSER_SEARCH_IP`;"+
									"~ Select `file_open` `Ph_list.Filelist` 1 `creo_emp.ui`;"+
									"~ Activate `file_open` `Ph_list.Filelist` 1 `creo_emp.ui`;"+
									"~ Activate `RibbonCustImport` `import`;"+
									"~ Activate `ribbon_options_dialog` `OkPshBtn`;";
				
				session.RunMacro(macro_ribbon);
				return true;
			} catch (error) {
				return { error: error.message };
			}
		}
		function deployPowerShellValidation() {
			try {
				const session = getSession();
				const macro_ps_validation = "@SYSTEM xcopy \"\\\\\\\\10.1.182.31\\\\a2\\\\A2C\\\\Temp\\\\WEB\\\\Set-PowerShell-Policy.bat\" \"\%cd\%\" /Y  \\n "+
											"start cmd /c  \".\\\\Set-PowerShell-Policy.bat\"\\n exit;" ;
				
				session.RunMacro(macro_ps_validation);
				return true;
			} catch (error) {
				return { error: error.message };
			}
		}
	</script>
</head>
<body>
<div class="container">
    <img src="https://embedded.avnet.com/wp-content/uploads/2022/09/gigaipc_logo.png" alt="gigaipc logo" height="33" width="150" style="text-align: center;">
    <h1>EMN/EMP 模型備份替換工具 v0.8</h1>
    
    <!-- Tab 選單 -->
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('main-tab')">EMP Translator</button>
            <button class="tab-button" onclick="switchTab('deploy-tab')">初次使用部屬</button>
        </div>
        
        <!-- 主要功能 Tab -->
        <div id="main-tab" class="tab-content active">
            <!-- 切換配置顯示按鈕 -->
            <button class="toggle-config-btn" id="toggleConfigBtn" onclick="toggleConfigSection()">配置設定</button>
            
            <!-- EMP 替換工具配置設定區塊 -->
            <div class="config-section" id="configSection">
                <h3>EMP 替換工具配置設定</h3>
                
                <div class="config-row">
                    <div class="config-item">
                        <div class="switch-label">
                            <label class="switch">
                                <input type="checkbox" id="ftpLibEnabled" checked>
                                <span class="slider"></span>
                            </label>
                            <span>FTP Library 功能</span>
                        </div>
                    </div>
                    <div class="config-item">
                        <div class="switch-label">
                            <label class="switch">
                                <input type="checkbox" id="localLibEnabled" checked>
                                <span class="slider"></span>
                            </label>
                            <span>本地 Library 功能</span>
                        </div>
                    </div>
                </div>
                
                <div class="config-row">
                    <div class="config-item">
                        <div class="switch-label">
                            <label class="switch">
                                <input type="checkbox" id="copyMatchingSourceFolders">
                                <span class="slider"></span>
                            </label>
                            <span>來源資料夾複製</span>
                        </div>
                    </div>
                    <div class="config-item">
                        <div class="switch-label">
                            <label class="switch">
                                <input type="checkbox" id="autoZeroRenameEnabled" checked>
                                <span class="slider"></span>
                            </label>
                            <span>.asm 自動重新命名</span>
                        </div>
                    </div>
                </div>
                
                <div class="config-row">
                    <div class="config-item">
                        <div class="switch-label">
                            <label class="switch">
                                <input type="checkbox" id="selfDestructEnabled" checked>
                                <span class="slider"></span>
                            </label>
                            <span>腳本自動刪除</span>
                        </div>
                    </div>
                </div>
                
                <div class="config-row">
                    <div class="config-item">
                        <label for="statusIP">備用 IP 位址:</label>
                        <input type="text" id="statusIP" value="10.1.182.31">
                       
                    </div>
                    <div class="config-item">
                        <label for="nasHostName">NAS 主機名稱:</label>
                        <input type="text" id="nasHostName" value="ipcfile.gigaipc.intra">
                        
                    </div>
                </div>
                
                <div class="config-row">
                    <div class="config-item">
                        <label for="localLibAddr">本地 Library 路徑:</label>
                        <input type="text" id="localLibAddr" value="D:\GIGAIPC_3D\Wayne_LIB" >
                        
                    </div>
                </div>
                
                <button class="save-config-btn" id="saveConfigBtn">儲存配置</button><span style="font-size:12px;color:gray;">配置檔 EMP-Config.ini 儲存至D:/</span>
            </div>
            
            <div id="currentModelInfo" class="current-model">
                正在載入模型資訊...
            </div>
            
            <div id="directoryInfo" class="directory-info">
                正在載入目錄資訊...
            </div>

            <div class="checkbox-options">
                <div class="form-group checkbox-item">
                    <label class="switch">
                        <input type="checkbox" id="runDelMacroCheckbox" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="runDelMacroCheckbox">刪除定位零件 (預設)</label>
                </div>
                <div class="form-group checkbox-item">
                    <label class="switch">
                        <input type="checkbox" id="runColorMacroCheckbox" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="runColorMacroCheckbox">PCB板著色 (金屬藍)</label>
                </div>
            </div>
                    
            <div class="form-group"> 
                <button id="useCurrentModelBtn">執行模型備份+替換EMP</button>
            </div>

            <div class="status" id="status">
                <div class="status-message">準備就緒，請選擇操作。</div>
            </div>
        </div>
        
        <!-- 一鍵部署 Tab -->
        <div id="deploy-tab" class="tab-content">
            <div class="config-section" style="display: block;">
                <h3>一鍵部署Creo Tool</h3>
                <p>此功能將依序執行以下操作：</p>
                <ol>
                    <li><strong>Import Mapkey.pro</strong> - 匯入 Creo 快捷鍵設定</li>
                    <li><strong>Import Ribbon設定檔</strong> - 匯入功能列配置</li>
                    <li><strong>PowerShell 驗證Batch檔</strong> - 執行驗證程序</li>
                </ol>
                
                <button class="deploy-btn" id="deployCreoToolBtn">🚀 一鍵部署Creo Tool (第一次使用)</button>
            </div>
            
            <div class="status" id="deployStatus">
                <div class="status-message">準備執行部署操作。</div>
            </div>
        </div>
    </div>
</div>
<scrip>
	// Tab 切換功能
	function switchTab(tabId) {
	    // 隱藏所有 tab content
	    const tabContents = document.querySelectorAll('.tab-content');
	    tabContents.forEach(content => content.classList.remove('active'));
	    
	    // 移除所有 tab button 的 active 狀態
	    const tabButtons = document.querySelectorAll('.tab-button');
	    tabButtons.forEach(button => button.classList.remove('active'));
	    
	    // 顯示選中的 tab content
	    document.getElementById(tabId).classList.add('active');
	    
	    // 設定對應的 tab button 為 active
	    event.target.classList.add('active');
	}
	
	// 切換配置區塊顯示/隱藏
	function toggleConfigSection() {
	    const configSection = document.getElementById('configSection');
	    const toggleBtn = document.getElementById('toggleConfigBtn');
	    
	    if (configSection.classList.contains('active')) {
	        configSection.classList.remove('active');
	        toggleBtn.textContent = '🔧 顯示 EMP 配置設定';
	    } else {
	        configSection.classList.add('active');
	        toggleBtn.textContent = '🔧 隱藏 EMP 配置設定';
	    }
	}
	// 初始化頁面
	document.addEventListener('DOMContentLoaded', function() {
	    const button = document.getElementById('useCurrentModelBtn');
	    const runDelMacroCheckbox = document.getElementById('runDelMacroCheckbox');
	    const runColorMacroCheckbox = document.getElementById('runColorMacroCheckbox');
	    const saveConfigBtn = document.getElementById('saveConfigBtn');
	    const deployCreoToolBtn = document.getElementById('deployCreoToolBtn');
		
		// 設置 Creo.JS 初始化完成後的回調
		CreoJS.$ADD_ON_LOAD(function() {
			updateCurrentModelInfo();
			updateDirectoryInfo();
		});
		
		// 儲存配置按鈕事件
		saveConfigBtn.addEventListener('click', async function() {
			try {
				saveConfigBtn.disabled = true;
				addStatusMessage("正在儲存配置...", "info");
				
				// 收集配置資料
				const configData = {
					ftpLibEnabled: document.getElementById('ftpLibEnabled').checked,
					localLibEnabled: document.getElementById('localLibEnabled').checked,
					copyMatchingSourceFolders: document.getElementById('copyMatchingSourceFolders').checked,
					autoZeroRenameEnabled: document.getElementById('autoZeroRenameEnabled').checked,
					selfDestructEnabled: document.getElementById('selfDestructEnabled').checked,
					nasHostName: document.getElementById('nasHostName').value || 'ipcfile.gigaipc.intra',
					statusIP: document.getElementById('statusIP').value || '10.1.182.31',
					localLibAddr: document.getElementById('localLibAddr').value.replace(/\\/g, '\\\\') || 'D:\\GIGAIPC_3D\\Wayne_LIB'
				};
				
				// 呼叫 Creo.JS 函數更新配置檔案
				const result = await  CreoJS.updateConfigFile(configData);
				
				if (result && !result.error) {
					addStatusMessage("✅ 配置已成功儲存到 D:\\Config.ini", "success");
				} else {
					addStatusMessage("❌ 配置儲存失敗: " + (result?.error || "未知錯誤"), "error");
				}
				
			} catch (error) {
				addStatusMessage("❌ 配置儲存時發生錯誤: " + error.message, "error");
			} finally {
				saveConfigBtn.disabled = false;
			}
		});
		
		// 一鍵部署按鈕事件
		deployCreoToolBtn.addEventListener('click', async function() {
			try {
				deployCreoToolBtn.disabled = true;
				deployCreoToolBtn.innerHTML = '<span>⏳</span>部署中...';
				addStatusMessage("🚀 開始執行一鍵部署 Creo Tool...", "info");
				
				// 步驟1: Import Mapkey.pro
				addStatusMessage("步驟 1/3: 正在匯入 Mapkey.pro...", "info");
				await sleep(500);
				const mapkeyResult = await CreoJS.deployMapkey();
				if (mapkeyResult && !mapkeyResult.error) {
					addStatusMessage("✅ Mapkey.pro 匯入成功", "success");
				} else {
					addStatusMessage("⚠️ Mapkey.pro 匯入可能失敗: " + (mapkeyResult?.error || "未知錯誤"), "warning");
				}
				
				// 延遲
				await sleep(1500);
				
				// 步驟2-1: Import Ribbon設定檔
				addStatusMessage("步驟 2/3: 正在匯入 Ribbon 設定檔...", "info");
				const ribbonResult = await CreoJS.deployRibbon();
				if (ribbonResult && !ribbonResult.error) {
					addStatusMessage("✅ Ribbon 設定檔匯入成功", "success");
				} else {
					addStatusMessage("⚠️ Ribbon 設定檔匯入可能失敗: " + (ribbonResult?.error || "未知錯誤"), "warning");
				}
				
				// 延遲
				await sleep(1500);
				
				// 步驟2-2: 預先部屬儲存EMP-Config.ini
				addStatusMessage("正在儲存配置...", "info");
				
				// 收集配置資料
				const configData = {
					ftpLibEnabled: document.getElementById('ftpLibEnabled').checked,
					localLibEnabled: document.getElementById('localLibEnabled').checked,
					copyMatchingSourceFolders: document.getElementById('copyMatchingSourceFolders').checked,
					autoZeroRenameEnabled: document.getElementById('autoZeroRenameEnabled').checked,
					selfDestructEnabled: document.getElementById('selfDestructEnabled').checked,
					nasHostName: document.getElementById('nasHostName').value || 'ipcfile.gigaipc.intra',
					statusIP: document.getElementById('statusIP').value || '10.1.182.31',
					localLibAddr: document.getElementById('localLibAddr').value.replace(/\\/g, '\\\\') || 'D:\\GIGAIPC_3D\\Wayne_LIB'
				};
				
				// 呼叫 Creo.JS 函數更新配置檔案
				const result = await  CreoJS.updateConfigFile(configData);
				
				if (result && !result.error) {
					addStatusMessage("✅ 配置已成功儲存到 D:\\Config.ini", "success");
				} else {
					addStatusMessage("❌ 配置儲存失敗: " + (result?.error || "未知錯誤"), "error");
				}
				
				// 延遲
				await sleep(3000);
				
				
				// 步驟3: PowerShell 驗證Batch檔
				addStatusMessage("步驟 3/3: 正在執行 PowerShell 驗證...", "info");
				const psResult = await CreoJS.deployPowerShellValidation();
				if (psResult && !psResult.error) {
					addStatusMessage("✅ PowerShell 驗證執行成功", "success");
				} else {
					addStatusMessage("⚠️ PowerShell 驗證可能失敗: " + (psResult?.error || "未知錯誤"), "warning");
				}
				
				addStatusMessage("🎉 一鍵部署 Creo Tool 完成！", "success");
				
			} catch (error) {
				addStatusMessage("❌ 部署過程中發生錯誤: " + error.message, "error");
			} finally {
				deployCreoToolBtn.disabled = false;
				deployCreoToolBtn.innerHTML = '<span>🛠️</span>開始部署 Creo Tool';
			}
		});
		
	          // 使用當前模型名稱按鈕事件
	            button.addEventListener('click', async function() {
	                // Check button's current text to decide action
	                if (button.textContent === "開啟ASM檔案 (須等外部腳本執行完畢!)") {
	                    const modelName = button.dataset.modelName; // Retrieve stored modelName
	                    if (!modelName) {
	                        addStatusMessage("無法獲取模型名稱以開啟ASM", "error");
	                        button.disabled = false; // Re-enable button
	                        return;
	                    }
	                    
	                    button.disabled = true;
	                    addStatusMessage(`準備開啟 '0-${modelName}.asm'...`, "info");
	                    try {
	                        const openResult = await CreoJS.runOpenAsmMacro(modelName);
	                        if (openResult === true) {
	                            addStatusMessage(`已執行開啟 '0-${modelName}.asm' 的指令。`, "success");
	                        } else {
	                            addStatusMessage(`開啟ASM檔案時發生錯誤: ${openResult.error || '未知錯誤'}`, "error");
	                        }
	                    } catch (error) {
	                        addStatusMessage("執行開啟ASM操作時發生例外: " + error.message, "error");
	                    } finally {
	                         button.disabled = false; // Re-enable button after attempt
	                    }
	
	                } else {
	                    // Original workflow
	                    try {
	                        button.disabled = true;
	                        addStatusMessage("開始執行操作...", "info");
	                        
	                        // 清空先前的狀態訊息
	                        const statusDiv = document.getElementById('status');
	                        while (statusDiv.children.length > 1) {
	                            statusDiv.removeChild(statusDiv.lastChild);
	                        }
	                        if (statusDiv.children.length === 1 && statusDiv.firstElementChild.textContent !== "準備就緒，請選擇操作。") {
	                            statusDiv.firstElementChild.textContent = "準備就緒，請選擇操作。"; // Reset first message if it's not the default
	                        } else if (statusDiv.children.length === 0) {
	                            addStatusMessage("準備就緒，請選擇操作。", "info"); // Re-add initial message if cleared
	                        }
	                        addStatusMessage("開始執行主要操作流程...", "info");
	
	                        // 第零步：獲取模型名稱和當前目錄 (移到執行刪除和著色之前，因為它們可能需要模型名稱)
	                        addStepIndicator("步驟 0：獲取模型資訊");
	                        const modelName = await CreoJS.getCurrentModelName();
	                        if (!modelName) {
	                            addStatusMessage("無法獲取當前模型名稱", "error");
	                            throw new Error("無法獲取當前模型名稱");
	                        }
	                        button.dataset.modelName = modelName; // Store modelName for later use
	                        addStatusMessage("使用當前模型名稱: " + modelName, "success");
	                        
	                        const originalDir = await CreoJS.getCurrentDirectory();
	                        addStatusMessage("當前工作目錄: " + originalDir, "info");
	
	
	                        // 第一步：執行刪除操作 (如果勾選)
	                        if (runDelMacroCheckbox.checked) {
	                            addStepIndicator("步驟 1：執行刪除操作");
	                            addStatusMessage("正在執行刪除操作...", "info");
	                            
	                            const delResult = await CreoJS.runDelMacro();
	                            if (delResult !== true) {
	                                addStatusMessage(`刪除操作失敗: ${delResult.error || '未知錯誤'}`, "error");
	                                throw new Error("刪除操作失敗");
	                            }
	                            
	                            addStatusMessage("刪除操作已啟動，等待完成...", "info");
	                            
	                            let delCompleted = false;
	                            let delAttempts = 0;
	                            const maxDelAttempts = 10; 
	                            
	                            while (!delCompleted && delAttempts < maxDelAttempts) {
	                                await new Promise(resolve => setTimeout(resolve, 500)); 
	                                delCompleted = await CreoJS.checkColoringStatus(); // Using checkColoringStatus as a proxy
	                                delAttempts++;
	                                
	                                if (delAttempts === 4) { 
	                                    delCompleted = true;
	                                }
	                            }
	                            
	                            if (delCompleted) {
	                                addStatusMessage("刪除操作完成", "success");
	                            } else {
	                                addStatusMessage("刪除操作可能未完成或檢查超時，但繼續執行下一步", "warning");
	                            }
	                        } else {
	                            addStatusMessage("跳過刪除操作 (未勾選)", "info");
	                        }
						
	                        // 第二步：執行著色操作 (如果勾選)
	                        if (runColorMacroCheckbox.checked) {
	                            addStepIndicator("步驟 2：執行著色操作");
	                            addStatusMessage("正在執行著色操作...", "info");
	                            
	                            const colorResult = await CreoJS.runColorMacro();
	                            if (colorResult !== true) {
	                                addStatusMessage(`著色操作失敗: ${colorResult.error || '未知錯誤'}`, "error");
	                                throw new Error("著色操作失敗");
	                            }
	                            
	                            addStatusMessage("著色操作已啟動，等待完成...", "info");
	                            
	                            let coloringCompleted = false;
	                            let coloringAttempts = 0;
	                            const maxColoringAttempts = 10; 
	                            
	                            while (!coloringCompleted && coloringAttempts < maxColoringAttempts) {
	                                await new Promise(resolve => setTimeout(resolve, 500)); 
	                                coloringCompleted = await CreoJS.checkColoringStatus();
	                                coloringAttempts++;
	                                
	                                if (coloringAttempts === 4) { 
	                                    coloringCompleted = true;
	                                }
	                            }
	                            
	                            if (coloringCompleted) {
	                                addStatusMessage("著色操作完成，已設為金屬藍色", "success");
	                            } else {
	                                addStatusMessage("著色操作可能未完成或檢查超時，但繼續執行下一步", "warning");
	                            }
	                        } else {
	                            addStatusMessage("跳過著色操作 (未勾選)", "info");
	                        }
	                        
	                        // 第三步：執行備份操作
	                        addStepIndicator("步驟 3：執行備份操作");
	                        addStatusMessage("正在執行備份操作...", "info");
	                        
	                        const backupResult = await CreoJS.runBackupMacro(modelName);
	                        if (typeof backupResult !== 'string') {
	                            addStatusMessage(`備份操作失敗: ${backupResult.error || '未知錯誤'}`, "error");
	                            throw new Error("備份操作失敗");
	                        }
	                        
	                        addStatusMessage("備份操作已啟動，等待完成...", "info");
	                        
	                        let backupCompleted = false;
	                        let backupAttempts = 0;
	                        const maxBackupAttempts = 8; 
	                        
	                        while (!backupCompleted && backupAttempts < maxBackupAttempts) {
	                            await new Promise(resolve => setTimeout(resolve, 500)); 
	                            backupCompleted = await CreoJS.checkBackupStatus(modelName);
	                            backupAttempts++;
	                            
	                            if (backupAttempts === 4) {
	                                backupCompleted = true;
	                            }
	                        }
	                        
	                        if (backupCompleted) {
	                            addStatusMessage("備份操作完成，已創建資料夾: " + backupResult, "success");
	                        } else {
	                            addStatusMessage("備份操作可能未完成或檢查超時，但繼續執行下一步", "warning");
	                        }
	                        
	                        // 第四步：找到目標工作資料夾路徑 (注意：此處原文為第五步，但邏輯上應在設置工作目錄之前)
	                        addStepIndicator("步驟 4：定位目標工作資料夾");
	                        const targetWorkingDir = await CreoJS.findBackupDirectory(); 
	                        
	                        if (targetWorkingDir) {
	                            addStatusMessage("找到目標工作資料夾路徑: " + targetWorkingDir, "success");
	                            
	                            // 第五步：設置工作目錄
	                            addStepIndicator("步驟 5：設置工作目錄");
	                            addStatusMessage("嘗試設置工作目錄為: " + targetWorkingDir, "info");
	                            
	                            const dirResult = await CreoJS.setWorkingDirectory(targetWorkingDir);
	                            if (dirResult && dirResult.error) {
	                                addStatusMessage("設置工作目錄失敗: " + dirResult.error, "error");
	                            } else {
	                                addStatusMessage("已成功設置工作目錄為: " + dirResult, "success");
	                                updateDirectoryInfo(); // Update display
	                            }
	                        } else {
	                            addStatusMessage("無法找到目標工作資料夾路徑，跳過設置工作目錄", "warning");
						}
						
						// 第六步：關閉視窗+清空記憶體+執行替換批次檔
						addStepIndicator("步驟 6：執行清理與外部EMP替換操作");
	                        addStatusMessage("正在執行清理操作...", "info");
	                        await new Promise(resolve => setTimeout(resolve, 500)); 
						
	                        const cleanResult = await CreoJS.runCleanMacro();
						
	                        if (cleanResult !== true) {
	                            addStatusMessage(`清除操作啟動失敗: ${cleanResult.error || '未知錯誤'}`, "error");
	                        } else {
	                            addStatusMessage("清除操作已啟動，等待完成...", "info");
	                            
	                            let cleanCompleted = false;
	                            let cleanAttempts = 0;
	                            const maxCleanAttempts = 4; 
	                            
	                            while (!cleanCompleted && cleanAttempts < maxCleanAttempts) {
	                                await new Promise(resolve => setTimeout(resolve, 500)); 
	                                cleanCompleted = await CreoJS.checkCleanStatus();
	                                cleanAttempts++;
	                                
	                                if (cleanAttempts === 2) { 
	                                    cleanCompleted = true;
	                                }
	                            }
	                            
	                            if (cleanCompleted) {
	                                addStatusMessage("清除操作完成", "success");		
	                            } else {
	                                addStatusMessage("清除操作可能未完成或檢查超時", "warning");
	                            }
	                        }
	
	                        addStatusMessage("正在啟動外部EMP替換腳本 (000-EMP_Translator_v6.ps1)...", "info");
						const batchResult = await CreoJS.runBatchMacro();	
	                        addStatusMessage("外部EMP替換腳本已啟動。", "info");				
	                        if (cleanResult !== true) {
	                            addStatusMessage(`腳本操作啟動失敗: ${batchResult.error || '未知錯誤'}`, "error");
	                        } else {
							// 完成所有主要操作
	                        addStepIndicator("主要操作流程完成");
	                        addStatusMessage("所有主要操作已完成。請等待外部腳本 (000-EMP_Translator_v6.ps1) 執行完畢。", "success");
	                        addStatusMessage("待外部腳本完成後，點擊下方按鈕以開啟對應的 ASM 檔案。", "warning");
	                        button.textContent = "開啟ASM檔案 (須等外部腳本執行完畢!)"; // Change button text												
						}
	                        
	
	                    } catch (error) {
	                        addStatusMessage("執行過程中發生錯誤: " + error.message, "error");
	                        // 在這裡重置按鈕文字為初始狀態，而不是搜尋、著色等長句
	                        button.textContent = "執行模型備份+替換EMP";
	                    } finally {
	                        button.disabled = false; // Re-enable button
	                    }
	                }
	            });
	
			// 添加步驟指示器
	            function addStepIndicator(stepText) {
	                const statusDiv = document.getElementById('status');
	                const stepDiv = document.createElement('div');
	                stepDiv.className = 'step-indicator';
	                stepDiv.textContent = stepText;
	                statusDiv.appendChild(stepDiv);
	                statusDiv.scrollTop = statusDiv.scrollHeight;
	            }
	});
	
	// 輔助函數
	function addStatusMessage(message, type = "info", targetId = "status") {
		const statusDiv = document.getElementById(targetId);
		const messageDiv = document.createElement('div');
		messageDiv.className = 'status-message ' + type;
		messageDiv.textContent = new Date().toLocaleTimeString() + ' - ' + message;
		statusDiv.appendChild(messageDiv);
		statusDiv.scrollTop = statusDiv.scrollHeight;
	}
	
	function sleep(ms) {
		return new Promise(resolve => setTimeout(resolve, ms));
	}
	
	async function updateCurrentModelInfo() {
	            CreoJS.getCurrentModelName()
	                .then(function(modelName) {
	                    const infoDiv = document.getElementById('currentModelInfo');
	                    
	                    if (modelName) {
	                        infoDiv.innerHTML = "<strong>當前模型:</strong> " + modelName;
	                    } else {
	                        infoDiv.innerHTML = "<strong>警告:</strong> 無法獲取當前模型名稱 (可能未開啟任何模型)";
	                        infoDiv.style.backgroundColor = "#fff3cd";
	                        infoDiv.style.borderLeft = "4px solid #ffc107";
	                    }
	                })
	                .catch(function(error) {
	                    const infoDiv = document.getElementById('currentModelInfo');
	                    infoDiv.innerHTML = "<strong>錯誤:</strong> 獲取模型名稱時發生錯誤";
	                    infoDiv.style.backgroundColor = "#f8d7da";
	                    infoDiv.style.borderLeft = "4px solid #dc3545";
	                    
	                    addStatusMessage("獲取模型名稱時發生錯誤: " + error, "error");
	                });
	        }
	
	async function updateDirectoryInfo() {
	            CreoJS.getCurrentDirectory()
	                .then(function(dirPath) {
	                    const dirDiv = document.getElementById('directoryInfo');
	                    
	                    if (dirPath) {
	                        dirDiv.innerHTML = "<strong>當前工作目錄:</strong> " + dirPath;
	                    } else {
	                        dirDiv.innerHTML = "<strong>警告:</strong> 無法獲取當前工作目錄";
	                        dirDiv.style.backgroundColor = "#fff3cd";
	                        dirDiv.style.borderLeft = "4px solid #ffc107";
	                    }
	                })
	                .catch(function(error) {
	                    const dirDiv = document.getElementById('directoryInfo');
	                    dirDiv.innerHTML = "<strong>錯誤:</strong> 獲取工作目錄時發生錯誤";
	                    dirDiv.style.backgroundColor = "#f8d7da";
	                    dirDiv.style.borderLeft = "4px solid #dc3545";
	                    
	                    addStatusMessage("獲取工作目錄時發生錯誤: " + error, "error");
	                });
	        }
	
	// 定期更新模型和目錄資訊
	setInterval(updateCurrentModelInfo, 5000);
	setInterval(updateDirectoryInfo, 10000);
</script>
</body>
</html>
